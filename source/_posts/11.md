---
title: å®Œå…¨é€šè¿‡ Github Actions å®ç°é¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²
date: 2021-09-23 13:28:25
updated: 2021-09-23 13:28:25
tags:
  - Github
  - Github Actions
  - è‡ªåŠ¨åŒ–éƒ¨ç½²
---

å‰æ®µæ—¶é—´å†™äº†ä¸€ä¸ªé€šè¿‡ Github Actions é…åˆ Webhooks å®ç°é¡¹ç›®è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸Šç”±äºå¹¶æ²¡æœ‰åç«¯æœåŠ¡ï¼Œæ‰€ä»¥å®ç°çš„æ–¹å¼ä¸å¤ªä¼˜é›…ã€‚ä»Šå¤©æˆ‘å°†å®Œå…¨æŠ›å¼ƒ Webhookï¼Œå®Œå…¨é€šè¿‡ Github Actions æ¥å®ç°é¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

<!--more-->

## æ”¹è¿›

å¦‚æœè¿˜æ²¡çœ‹è¿‡ä¸Šä¸€ç¯‡çš„ï¼Œå¯ä»¥ç§»æ­¥è¿™é‡Œçœ‹ä¸€ä¸‹[Github Actions + Webhooks å®ç°é¡¹ç›®è‡ªåŠ¨åŒ–éƒ¨ç½²](/posts/10/)ã€‚

è¿™æ¬¡çš„ä¸»è¦æ”¹è¿›å°±æ˜¯ç§»é™¤äº† Webhooks çš„ä¾èµ–ï¼Œä¸éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œç›‘å¬ã€‚

å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡ Github Actions ä¸»åŠ¨ç™»å½•æœåŠ¡å™¨ï¼Œæ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ï¼Œå®Œæˆ git pull æ“ä½œã€‚

## Gihub Actions è„šæœ¬

[å®Œæ•´è„šæœ¬](https://github.com/ZvonimirSun/my-hexo-blog/blob/73af98ae4ef95156d2e51697633b9fb43c59386e/.github/workflows/deploy.yml)

å¤§è‡´å†…å®¹å’Œä¹‹å‰æ˜¯ä¸€æ ·çš„ï¼Œä¼˜åŒ–äº†ä¸¤ä¸ªåœ°æ–¹ã€‚

### å¢åŠ ç¼“å­˜

å¢åŠ äº†å¯¹`node_modules`ç›®å½•çš„ç¼“å­˜ï¼Œä»è€Œåœ¨å¤§éƒ¨åˆ†æ—¶é—´é‡ŒåŠ é€Ÿå®‰è£…ä¾èµ–çš„æ—¶é—´ã€‚ç”±äº yarn çš„æœºåˆ¶ï¼Œåœ¨æ²¡æœ‰æ›´æ–° yarn.lock æ–‡ä»¶æ—¶ï¼Œå®‰è£…ä¾èµ–å‡ ä¹å¯ä»¥è¯´æ˜¯ç›´æ¥è·³è¿‡çš„ï¼Œä»è€Œå¤§å¤§ç¼©çŸ­äº†æ¯æ¬¡éƒ¨ç½²çš„æ—¶é—´ã€‚

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
      - name: Restore cached ./node_modules
        uses: actions/cache@v2
        with:
          path: ./node_modules
          key: ${{ runner.os }}-yarn-lock-${{ hashFiles('./yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-lock-
```

å¯ä»¥çœ‹åˆ°è¿™è¾¹é‡‡ç”¨äº†å®˜æ–¹çš„`actions/cache@v2`è„šæœ¬ï¼Œæ ¹æ® yarn.lock çš„ hash å€¼æ¥ç¼“å­˜ node_modules ç›®å½•ï¼Œå¯ä»¥ä¸ç”¨æ‹…å¿ƒæ²¡æ³•å‡çº§ä¾èµ–ã€‚

### ç™»å½•æœåŠ¡å™¨

è¿™è¾¹ä¸ºäº†å®‰å…¨å› ç´ ï¼Œå»ºè®®å°†ç™»å½•å‚æ•°å‚¨å­˜åˆ°é¡¹ç›®çš„ Secrets ä¸­ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡ç¯å¢ƒå˜é‡åœ¨ Github Actions ä¸­è°ƒç”¨ï¼Œä¸ç”¨æ‹…å¿ƒæ³„éœ²çš„é—®é¢˜ã€‚

![Secrets](https://img.iszy.xyz/20210923134132.png)

ç‚¹å‡»é¡¹ç›®çš„`Settings`-`Secrets`-`New repository secret`å³å¯åˆ›å»ºã€‚Secret åç§°å°±æ˜¯ç¯å¢ƒå˜é‡åï¼Œå†…å®¹åˆ™æ˜¯å…·ä½“çš„å€¼ã€‚

æ¥ç€è°ƒç”¨`appleboy/ssh-action@master`è„šæœ¬ï¼Œå°†ç™»å½•å‚æ•°æŒ‡å®šä¸ºå¯¹åº”çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åé…ç½®ä¸€ç»„éœ€è¦æ‰§è¡Œçš„è„šæœ¬ï¼Œè¿™è¾¹å¯ä»¥æ ¹æ®ä¸ªäººçš„å®é™…æƒ…å†µè¿›è¡Œé…ç½®ï¼Œè‡ªç”±åº¦å¾ˆé«˜äº†ã€‚æ—¢ç„¶éƒ½èƒ½ç™»é™†æœåŠ¡å™¨ï¼Œé‚£è‡ªç„¶æ˜¯æƒ³åšä»€ä¹ˆéƒ½å¯ä»¥äº†ã€‚

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
      - name: Restore cached ./node_modules
        uses: actions/cache@v2
        with:
          path: ./node_modules
          key: ${{ runner.os }}-yarn-lock-${{ hashFiles('./yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-lock-
      - name: Install hexo
        run: npm install hexo-cli -g
      - name: Install dependencies ğŸ”§
        run: yarn install --frozen-lockfile
      - name: Build app ğŸ”§
        run: hexo g
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.0
        with:
          branch: gh-pages
          folder: public
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          script: |
            cd /your/path
            git pull --rebase
            ls -al
```

## ä½¿ç”¨ä½“éªŒ

è¿™æ¬¡çš„ä½“éªŒå¾ˆå¥½ï¼ŒåŸºæœ¬ä¸Šä¸ç”¨æµªè´¹è‡ªå·±æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„è„šæœ¬å°†æœåŠ¡å™¨ä¸Šè‡ªå·±å…³å¿ƒçš„å†…å®¹è¾“å‡ºåˆ°æ—¥å¿—ä¸­ã€‚æˆ‘æš‚æ—¶è®¤ä¸ºè¿™å°±æ˜¯ç°é˜¶æ®µé€šè¿‡ Github Actions å®Œæˆè‡ªåŠ¨åŒ–éƒ¨ç½²çš„æœ€ä½³æ–¹æ¡ˆäº†ã€‚å¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚
